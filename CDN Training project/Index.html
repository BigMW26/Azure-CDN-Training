<!DOCTYPE html>
<html lang="en">

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8"/>
	<title>Azure CDN Support Training</title>
	<link rel="stylesheet" type="text/css" href="./style.css">
</head>

<body>
	<div class="navbar"> 
		<a href="./index.html">Home</a>
		<a href="./pre-training.html">Pre-Training</a>
	</div>
	<div class="main">
		<div style="display: flex">
			<div style="float: left">
				<h1>CDN TRAINING WORKING PATH</h1>
				<h2>CDN overview</h2>
				<p>View the <a href="https://microsoft-my.sharepoint.com/:p:/p/wyattm/ETVyrYAF4TdNqHIti6CYTVkBeedYcKKagqBv50-vzIMy-g?e=UodM4r">CDN overview presentation</a></p>
				<p>Who knew what CDN was before it was brought to our team?</p>
				<p>What did you get out of the introcutory PowerPoint presentation?</p>
			</div>
			<div style="float: right; max-width: 50%;">
				<img src="./images/cdn_logo.png" style="max-width: inherit" alt="CDN Logo">
			</div>
		</div>
		<div>
			<h2>Verifying Profile and endpoint data</h2>
			<p>Goto ASC using the following link for use without an SR.
				<a
					href="https://azuresupportcenter.msftcloudes.com/?features=nosr">https://azuresupportcenter.msftcloudes.com/?features=nosr</a>
			</p>
			<p>Enter your Subscription ID, can get this from the portal profile information</p>
			<p>Navigate to Resource Explorer and search by provider for Microsoft.CDN</p>
			<p>Select your profile</p>
		</div>
		<div style="display: flex">
			<div style="float: left; max-width:50%;">
				<h3>View in Jarvis</h3>
				<p>Click the ACIS Url link in the properties of your CDN</p>
				<p>Sample link: <a
						href="https://jarvis-west.dc.ad.msft.net/F32963BE?genevatraceguid=ac445232-71a2-46dd-b8e9-b5875eede057">https://jarvis-west.dc.ad.msft.net/F32963BE?genevatraceguid=ac445232-71a2-46dd-b8e9-b5875eede057</a>
				</p>
				<p>You can also get the profiles using "Get Resource from Subscription" in Jarvis: <a
						href="https://jarvis-west.dc.ad.msft.net/F54F5046">https://jarvis-west.dc.ad.msft.net/F54F5046</a></p>
				<p>Review CDN operations with Jarvis logs: <a href="https://jarvis-west.dc.ad.msft.net/89EC79E">FD/CDN Jarvis Logs</a></p>
				<h3>Finding management operations with Kusto</h3>
				<p>Sample Kusto Query Execute: [<a href="https://dataexplorer.azure.com/clusters/armprod.kusto.windows.net/databases/ARMProd?query=H4sIAAAAAAAEAG3PPU%2fDMBSF4R2J%2f3CVqQyWbpzgtBFBQqISGZJG1FO3i33VeKgdYkcs%2fHg%2bMpSBMz%2fvcF5Smg5LOgfnz6%2f8vnBMET7hY%2bSZYaPbbn%2fUT90Ajw1YSpzchTcS851AKfJc56rGbY3F6Q7IW7j6h3%2b41Ii1XPnq4%2fIWzeym5IJvLTQNZIRoEBWJaktKlDtbCjKFFKwqWd7LolKlzH7jMPFMP2VPFwYTfCLnI2T7%2fnk4tL0%2brmz8fthxGoP9YwZKZsxub%2bC6LyoJeeYKAQAAWeb">Web</a>] [<a href="https://armprod.kusto.windows.net:443/ARMProd?query=H4sIAAAAAAAEAG3PPU%2fDMBSF4R2J%2f3CVqQyWbpzgtBFBQqISGZJG1FO3i33VeKgdYkcs%2fHg%2bMpSBMz%2fvcF5Smg5LOgfnz6%2f8vnBMET7hY%2bSZYaPbbn%2fUT90Ajw1YSpzchTcS851AKfJc56rGbY3F6Q7IW7j6h3%2b41Ii1XPnq4%2fIWzeym5IJvLTQNZIRoEBWJaktKlDtbCjKFFKwqWd7LolKlzH7jMPFMP2VPFwYTfCLnI2T7%2fnk4tL0%2brmz8fthxGoP9YwZKZsxub%2bC6LyoJeeYKAQAA&web=0">Desktop</a>] [<a href="https://lens.msftcloudes.com/v2/#/discover/query//results?datasource=(cluster:armprod.kusto.windows.net,database:ARMProd,type:Kusto)&query=H4sIAAAAAAAEAG3PPU%2fDMBSF4R2J%2f3CVqQyWbpzgtBFBQqISGZJG1FO3i33VeKgdYkcs%2fHg%2bMpSBMz%2fvcF5Smg5LOgfnz6%2f8vnBMET7hY%2bSZYaPbbn%2fUT90Ajw1YSpzchTcS8">Web (Lens)</a>] [<a href="https://armprod.kusto.windows.net:443/ARMProd?query=H4sIAAAAAAAEAG3PPU%2fDMBSF4R2J%2f3CVqQyWbpzgtBFBQqISGZJG1FO3i33VeKgdYkcs%2fHg%2bMpSBMz%2fvcF5Smg5LOgfnz6%2f8vnBMET7hY%2bSZYaPbbn%2fUT90Ajw1YSpzchTcS851AKfJc56rGbY3F6Q7IW7j6h3%2b41Ii1XPnq4%2fIWzeym5IJvLTQNZIRoEBWJaktKlDtbCjKFFKwqWd7LolKlzH7jMPFMP2VPFwYTfCLnI2T7%2fnk4tL0%2brmz8fthxGoP9YwZKZsxub%2bC6LyoJeeYKAQAA&saw=1">Desktop (SAW)</a>] <a href="https://armprod.kusto.windows.net:443/ARMProd">https://armprod.kusto.windows.net:443/ARMProd</a></p>
				<pre><code>
						HttpOutgoingRequests | where (TIMESTAMP >= datetime(2019-02-11T16:08:03Z) and 
						TIMESTAMP < datetime(2019-02-12T00:28:03Z)) and subscriptionId == "a00c006a-78a6-49d4-ac32-e67245237642" and 
						operationName contains "ENDPOINTS" and httpMethod contains "Patch"</code></pre>
			</div>
			<div style="max-width: 50%; float: left"><img src="./images/get_resource_from_sub.png"
					style="max-width: inherit" alt="Get Resource from Subscription Image"/>
			</div>
		</div>
		<div>
			<h2>Was asset served by Microsoft CDN, WGET install and Impression Log Search</h2>
			<h3>Use WGET to get the ref string response header</h3>
			<p>Open CMD prompt and change directory to C:\Program Files (x86)\GnuWin32\bin</p>
			<p>Run WGET cmd</p>
			<p>Sample command: wget -S -O NUL --no-check-certificate <a
					href="https://%3calias%3ecdn.azureedge.net/images/cdn_logo.png">https://&lt;alias&gt;cdn.azureedge.net/images/cdn_logo.png</a>
			</p>
			<h3>Follow instruction for use of Impressions Log Search tool</h3>
			<p><a
					href="onenote:https://microsoft.sharepoint.com/teams/DSHome/azure/Shared%20Documents/Azure%20PaaS%20POD/CDN/Microsoft%20CDN.one#%5bHowTo%5d%20Check%20if%20Asset%20was%20served%20from%20Microsoft%20CDN%20Cache&amp;section-id={C419F011-BB2C-49BF-A3E2-F4E89D38B334}&amp;page-id={56F22C7A-FD97-469F-9496-6EA03990E20A}&amp;end">How
					to Check if Asset was served from Microsoft CDN Cache</a>
				(<a
					href="https://microsoft.sharepoint.com/teams/DSHome/azure/_layouts/OneNote.aspx?id=%2Fteams%2FDSHome%2Fazure%2FShared%20Documents%2FAzure%20PaaS%20POD&amp;wd=target%28CDN%2FMicrosoft%20CDN.one%7CC419F011-BB2C-49BF-A3E2-F4E89D38B334%2F%5BHowTo%5D%20Check%20if%20Asset%20was%20served%20from%20Microsoft%20CDN%7C56F22C7A-FD97-469F-9496-6EA03990E20A%2F%29">Web
					view</a>)</p>
			<p>Impression Log Search: <a
					href="https://www.afdcp.com/ImpressionLogSearch">https://www.afdcp.com/ImpressionLogSearch</a></p>
		</div>
		<h2>Testing different regions</h2>

		<p>Follow the WGET process with Impression Log Search to see if the POP that's serving
			the asset has cached the image as well.</p>

		<p>Try a different image file following the folder structure of the project files.</p>

		<p>Use WhatsMyDNS to determine the IP addresses of your CDN endpoint in different regions</p>

		<p>Link to WhatsMyDNS <a href="https://www.whatsmydns.net">https://www.whatsmydns.net</a></p>

		<p>Run WGET cmd to test from the secondary region</p>

		<p>Sample cmd: wget -S -O NUL --header="Host:&lt;alias&gt;cdn.azureedge.net"
			http://&lt;ipaddress&gt;/images/cdn_logo.png.png</p>
		<h2>Using cURL</h2>
		<p><bold>cURL is a command run in Bash that allows you to see a specific URL’s response header and HTTP status. It can be helpful in troubleshooting caching issues and 4xx/5xx errors. It’s also a dope way to get massive arm circumference.</bold></p>
		<p>Using cURL in troubleshooting is as simple as the following command: </p>
		<ul>
			<li>$ curl -I <url> </li>
		</ul>
		<p>Which will result in an output similar to (relevant information highlighted):</p>
		<ul>
			<li>$ curl -I "https://pbs.twimg.com/media/EC_ROiQXsAAzkxi?format=jpg&name=4096x4096" <br>

				HTTP/1.1 200 OK <br>
				
				Accept-Ranges: bytes <br>
				
				access-control-allow-origin: * <br>
				
				access-control-expose-headers: Content-Length <br>
				
				cache-control: max-age=604800, must-revalidate <br>
				
				Content-Type: image/jpeg <br>
				
				Date: Tue, 27 Aug 2019 19:34:32 GMT <br>
				
				Last-Modified: Tue, 27 Aug 2019 16:02:05 GMT <br>
				
				Server: ECS (sjc/4E32) <br>
				
				strict-transport-security: max-age=631138519 <br>
				
				surrogate-key: media media/bucket/1 media/1166380876156088320 <br>
				
				X-Cache: HIT <br>
				
				x-connection-hash: bb4be70a053d9f034ef2cfe16199e3d0 <br>
				
				x-content-type-options: nosniff <br>
				
				x-response-time: 200 <br>
				
				Content-Length: 427398 </li>
		</ul>
		<p>4xx/5xx errors:</p>
		<ul>
			<li>Run curl against both the endpoint and the origin, if the error response matches at each URL, you can rule out the CDN endpoint as an issue </li>
		</ul>
		<p>Cache control Headers: </p>
		<ul>
			<li>If max-age here is set to 0, the CDN endpoint will not cache content. The CDN can be set to override origin caching settings </li>
		</ul>
		<p>CDN cache function: </p>
		<ul>
			<li>Run curl with the file URL itself. If the response here shows/includes “HIT,” the content is being served from the CDN’s cache; a response of MISS would mean content is being served by the origin and caching behavior is not taking place. </li>
		</ul>
		<p>*responses for all curl commands may vary slightly depending on provider; always check  <a href="https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN%2FCommon%2FHow%20To%2FTSG%20%252D%20Caching%20Issues&pageId=210780&wikiVersion=GBmaster">https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN%2FCommon%2FHow%20To%2FTSG%20%252D%20Caching%20Issues&pageId=210780&wikiVersion=GBmaster</a> for provider-specific guides. </p>
		<h2>Use Dig DNS</h2>
		<p>Use Dig to get additional data like CNAME and other DNS records associated with the
			CDN URL. Helpful in cases with custom DNS configured
			<a href="http://digdns.com">http://digdns.com</a></p>

		<p>Link for instruction: <a
				href="https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN%2FCommon%2FTools%2FCommon%20External%20Tools&pageId=24315&wikiVersion=GBmaster">Common
				External Tools</a></p>

		<h2>Using Fiddler for captures</h2>
		<p>(The Impression log search must be used to examine log if performed on VM as this
			request doesn't originate on corp network)</p>

		<h2>Troubleshooting workflow</h2>
			<p><a
					href="https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN%2FStart%20Here&pageId=210812&wikiVersion=GBmaster">Start Here</a></p>
					
			<p>Akamai handling process and escalation process: <a
					href="https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN%2FAkamai%2FEscalate%20to%20Akami&pageId=179793&wikiVersion=GBmaster">Escalate to Akamai</a> <br>
					Both parties will work the issue until it is decided which on is no longer needed.</p>

			<p>Verizon CDN handling process: <a
					href="https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN%2FVerizon%2FEscalate%20to%20Verizon&pageId=24325&wikiVersion=GBmaster">Escalate to Verizon</a><br>
					After identifying and looking through the issue using the troubleshooting workflow, an escalation to Version maybe necessary<br>
			Verizon Node Status: <a
					href="https://status.verizondigitalmedia.com/">https://status.verizondigitalmedia.com/</a></p>

			<h2>Common Scenarios and Escalations</h2>

			<ul>
				<li>
					<p>Setup issues</p>
				</li>
				<li><a href="https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN%2FCommon%2FHow%20To%2FTSG%20%252D%20Caching%20Issues&pageId=210780&wikiVersion=GBmaster">Cache/Expiration and purging issues</a></li>
				<li>
					<p>Service not Available <a
							href="https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN%2FMicrosoft%2FTSG%20%252D%20Our%20Services%20are%20not%20Available%20Right%20Now&pageId=179767&wikiVersion=GBmaster">Our services aren't available right now</a><br>
							usually a matter of waiting after creating a new CDN profile and endpoint.<br> Will require ICM if correctly configured and unavailable after 3 hours. However, this can take longer sometimes.</p>
				</li>
				<li>Verizon Cache settings: <a
						href="onenote:https://microsoft.sharepoint.com/teams/DSHome/azure/Shared%20Documents/Azure%20PaaS%20POD/CDN/Verizon%20CDN.one#Verizon%20Cache%20Settings%20and%20Expiration&amp;section-id={0A7AC361-F54B-41F3-917E-610F4B43A550}&amp;page-id={25A6B0BE-0AD7-4BF3-A4C2-EDFA290AFA0C}&amp;end">Verizon
						Cache Settings and Expiration</a> (<a
						href="https://microsoft.sharepoint.com/teams/DSHome/azure/_layouts/OneNote.aspx?id=%2Fteams%2FDSHome%2Fazure%2FShared%20Documents%2FAzure%20PaaS%20POD&amp;wd=target%28CDN%2FVerizon%20CDN.one%7C0A7AC361-F54B-41F3-917E-610F4B43A550%2FVerizon%20Cache%20Settings%20and%20Expiration%7C25A6B0BE-0AD7-4BF3-A4C2-EDFA290AFA0C%2F%29">Web
						view</a>)
					<p>This may require escalation to Verizon</p>
				</li>
				<li>
					<p>Upgrading
						profile from Standard to Premium: <a
							href="https://docs.microsoft.com/en-us/azure/cdn/cdn-migrate">https://docs.microsoft.com/en-us/azure/cdn/cdn-migrate</a>
					</p>
					<p>This requires escalation to MS PG: <a
							href="https://aka.ms/ALLCDN_ICM">https://aka.ms/ALLCDN_ICM</a>
						(to be added to ASC in the near future)</p>
				</li>
				<li>
					<p>Edge node IP whitelisting on Origin server</p>					
					<p><a
							href="https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN%2FMicrosoft%2FIP%20Addresses%20Ranges%20for%20MS%20CDN%20Edge%20Servers&pageId=179766&wikiVersion=GBmaster">IP Address Ranges</a></p>
					<p>Edge Nodes List: <a
							href="https://docs.microsoft.com/en-us/rest/api/cdn/edgenodes/list">https://docs.microsoft.com/en-us/rest/api/cdn/edgenodes/list</a>
					</p>
				</li>
				<li>
					<p>SSL Enablement Stuck for Akamai</p>
					<p>Run Kusto query: <a
							href="https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN%2FAkamai%2FAkamai%20CDN%20Known%20Issues&pageId=179788&wikiVersion=GBmaster&anchor=adding-ssl-to-a-custom-domain-hangs"></a>
							<p>If the substate shows "PendingDomainControlValidationRequestApproval", that means Akamai failed to validate the custom domain.</p>
					<p>May require an ICM to PG for redirection path as explained in OneNote if CNAME record is correct
						or corrected and still cannot validate custom domain</p>
				</li>
			</ul>
			<h2>Available Resources</h2>
			<ul>
				
				<li>
					<p><a
							href="https://teams.microsoft.com/l/channel/19%3ab8658405f4934abbbdf9b32ed6023e19%40thread.skype/Azure%2520CDN%2520(Verizon%252C%2520Akamai%2520and%2520MS)?groupId=c3e00ac7-3f76-4350-ba3b-e335a6bbbe21&amp;tenantId=72f988bf-86f1-41af-91ab-2d7cd011db47">Teams
							CDN Channel</a></p>
				</li>
				<li>
					<p><a
							href="https://supportability.visualstudio.com/AzureNetworking/_wiki/wikis/Wiki?pagePath=%2FAzure%20CDN&pageId=24301&wikiVersion=GBmaster">Azure CDN WiKi</a>
					</p>
				</li>
			</ul>
	</div>
</body>

</html>